# 飞书开放平台配置完整指南

本文档详细说明如何在飞书开放平台配置机器人，包括事件订阅（回调）配置。

## 📋 配置步骤概览

1. ✅ 创建飞书应用
2. ✅ 配置应用权限
3. ✅ **配置事件订阅（回调）** ⭐ 重要
4. ✅ 添加机器人到群聊
5. ✅ 测试机器人

---

## 步骤 1: 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 使用飞书账号登录
3. 点击右上角头像 > "创建企业自建应用"
4. 填写应用信息：
   - **应用名称**: 今天吃什么
   - **应用描述**: 随机推荐餐厅的群机器人
   - **应用图标**: 可选，上传一个图标
5. 点击"创建"
6. **重要：记录以下信息**
   - `App ID` (应用ID)
   - `App Secret` (应用密钥) - 点击"查看"后复制

---

## 步骤 2: 配置应用权限

1. 在应用管理页面，点击左侧菜单 **"权限管理"**
2. 在"权限配置"中找到以下权限，点击"申请权限"：

   ### 必需权限：
   
   - ✅ **`im:message`** 
     - 权限说明：获取与发送单聊、群组消息
     - 权限范围：需要选择"可用范围"（通常是"全部"或指定群组）
   
   - ✅ **`im:message:group_at_msg:readonly`**
     - 权限说明：接收群聊中@机器人消息事件
     - 权限范围：需要选择"可用范围"

3. 申请权限后，需要**提交审核**（企业自建应用通常会自动通过）
4. 等待权限审核通过（通常几分钟内）

---

## 步骤 3: 配置事件订阅（回调）⭐ 最重要

这是**最关键的一步**，必须配置才能接收群聊消息。

### 3.1 进入事件订阅页面

1. 在应用管理页面，点击左侧菜单 **"事件订阅"**
2. 你会看到"请求地址 URL"配置区域

### 3.2 配置请求地址（Webhook）

1. **先部署你的服务器**（参考 [DEPLOY_VERCEL.md](./DEPLOY_VERCEL.md) 或其他部署文档）
2. 获取你的 Webhook 地址，格式为：
   ```
   https://your-domain.com/webhook
   ```
   
   例如：
   - Vercel: `https://feishu-bot-what-to-eat.vercel.app/webhook`
   - Railway: `https://your-app.railway.app/webhook`
   - Render: `https://your-app.onrender.com/webhook`

3. 在"请求地址 URL"输入框中填入你的 Webhook 地址

4. **如果配置了加密**（可选）：
   - 在"Encrypt Key"中填入你的加密密钥
   - 这个密钥需要与服务器环境变量 `FEISHU_ENCRYPT_KEY` 一致

5. **如果配置了验证令牌**（可选）：
   - 在"Verification Token"中填入你的验证令牌
   - 这个令牌需要与服务器环境变量 `FEISHU_VERIFICATION_TOKEN` 一致

6. 点击 **"保存"** 按钮

7. **飞书会自动验证地址**：
   - 飞书会发送一个验证请求到你的 Webhook 地址
   - 你的服务器需要返回 `{"challenge": "xxx"}` 格式
   - 如果验证成功，会显示"验证成功"的提示
   - 如果验证失败，检查：
     - Webhook 地址是否正确
     - 服务器是否正常运行
     - 服务器日志是否有错误

### 3.3 添加订阅事件

1. 在事件订阅页面，找到 **"订阅事件"** 部分
2. 点击 **"添加事件"** 按钮
3. 在事件列表中找到并选择：
   - ✅ **`im.message.receive_v1`** - 接收消息事件
4. 点击"确定"
5. 确保事件状态为"已订阅"

### 3.4 事件订阅配置完成

配置完成后，页面应该显示：
- ✅ 请求地址 URL: `https://your-domain.com/webhook` (已验证)
- ✅ 订阅事件: `im.message.receive_v1` (已订阅)

---

## 步骤 4: 添加机器人到群聊

1. 在应用管理页面，点击左侧菜单 **"机器人"**
2. 在"机器人信息"中：
   - 设置机器人名称：`今天吃什么`
   - 设置机器人描述：`随机推荐餐厅`
   - 上传机器人头像（可选）
3. 点击"保存"
4. **将机器人添加到群聊**：
   - 打开飞书，进入目标群聊
   - 点击群聊右上角"设置"图标
   - 选择"群机器人"
   - 点击"添加机器人"
   - 搜索并选择你的应用"今天吃什么"
   - 点击"添加"

---

## 步骤 5: 测试机器人

### 5.1 验证服务器运行

访问健康检查接口：
```
https://your-domain.com/health
```

应该返回：
```json
{
  "status": "ok",
  "restaurants_count": 45,
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 5.2 测试 Webhook 回调

使用 curl 测试：
```bash
curl -X POST https://your-domain.com/webhook \
  -H "Content-Type: application/json" \
  -d '{"type":"url_verification","challenge":"test123"}'
```

应该返回：
```json
{"challenge":"test123"}
```

### 5.3 在群聊中测试

1. 在已添加机器人的群聊中
2. 发送消息：`@今天吃什么`
3. 机器人应该回复一个随机餐厅，例如：
   ```
   🎲 今天去吃：**寿司沼津港漕河泾印象城店** 🍽️
   ```

---

## 📝 配置检查清单

在开始使用前，确保以下所有项都已配置：

- [ ] 已创建飞书应用
- [ ] 已记录 App ID 和 App Secret
- [ ] 已申请并开通 `im:message` 权限
- [ ] 已申请并开通 `im:message:group_at_msg:readonly` 权限
- [ ] 已部署服务器并获取 Webhook 地址
- [ ] 已在事件订阅中配置请求地址 URL
- [ ] 请求地址 URL 验证成功
- [ ] 已添加 `im.message.receive_v1` 事件订阅
- [ ] 已在机器人页面配置机器人信息
- [ ] 已将机器人添加到目标群聊
- [ ] 已在服务器环境变量中配置 App ID 和 App Secret

---

## 🔧 常见问题

### Q1: 事件订阅验证失败

**可能原因：**
1. Webhook 地址不正确
2. 服务器未运行或无法访问
3. 服务器代码未正确处理验证请求
4. 网络问题

**解决方法：**
1. 检查 Webhook 地址格式是否正确（必须是 HTTPS）
2. 访问健康检查接口确认服务器运行正常
3. 查看服务器日志，确认是否收到验证请求
4. 检查服务器代码中的 URL 验证逻辑

### Q2: 机器人不响应@消息

**可能原因：**
1. 事件订阅未正确配置
2. 权限未开通
3. 机器人未添加到群聊
4. 服务器代码逻辑问题

**解决方法：**
1. 检查事件订阅页面，确认 `im.message.receive_v1` 已订阅
2. 检查权限管理，确认两个权限都已开通
3. 确认机器人已添加到群聊
4. 查看服务器日志，确认是否收到消息事件

### Q3: 权限审核未通过

**解决方法：**
1. 检查权限申请时是否选择了正确的可用范围
2. 联系企业管理员审批权限
3. 如果是个人开发者，确保使用企业自建应用（不需要审核）

### Q4: 如何查看服务器日志

**不同平台查看日志的方式：**

- **Vercel**: 项目 > Deployments > 选择部署 > Functions > api/index.js > Logs
- **Railway**: 项目 > 选择服务 > Logs
- **Render**: 服务 > Logs
- **Fly.io**: `fly logs`

---

## 📚 相关文档

- [README.md](./README.md) - 项目完整说明
- [DEPLOY_VERCEL.md](./DEPLOY_VERCEL.md) - Vercel 部署指南
- [DEPLOY.md](./DEPLOY.md) - 其他平台部署指南
- [WEBHOOK.md](./WEBHOOK.md) - Webhook 配置说明

---

## 🎯 快速参考

### 必需配置项

| 配置项 | 位置 | 说明 |
|--------|------|------|
| App ID | 应用凭证 | 在"应用信息"页面查看 |
| App Secret | 应用凭证 | 在"应用信息"页面查看 |
| 请求地址 URL | 事件订阅 | 你的 Webhook 地址 |
| 订阅事件 | 事件订阅 | `im.message.receive_v1` |
| 权限 | 权限管理 | `im:message` 和 `im:message:group_at_msg:readonly` |

### Webhook 地址格式

```
https://your-domain.com/webhook
```

### 环境变量配置

在部署平台配置以下环境变量：
- `FEISHU_APP_ID` = 你的 App ID
- `FEISHU_APP_SECRET` = 你的 App Secret
- `FEISHU_ENCRYPT_KEY` = 加密密钥（如果配置了）
- `FEISHU_VERIFICATION_TOKEN` = 验证令牌（如果配置了）

---

配置完成后，你的机器人就可以正常工作了！🎉

